# Developer Portal
[![semver](https://github.com/vonage-technology/devhub-portal/actions/workflows/validate-semantic-version.yml/badge.svg)](https://github.com/vonage-technology/devhub-portal/actions/workflows/validate-semantic-version.yml) 
[![semver](https://github.com/vonage-technology/devhub-portal/actions/workflows/bump-semantic-version.yml/badge.svg)](https://github.com/vonage-technology/devhub-portal/actions/workflows/bump-semantic-version.yml) 
[![semver](https://github.com/vonage-technology/devhub-portal/actions/workflows/pull-request-integration-build.yml/badge.svg)](https://github.com/vonage-technology/devhub-portal/actions/workflows/pull-request-integration-build.yml) 
[![CI](https://github.com/vonage-technology/devhub-portal/actions/workflows/continuous-integration.yml/badge.svg)](https://github.com/vonage-technology/devhub-portal/actions/workflows/continuous-integration.yml) 
[![Buiild TechDocs](https://github.com/vonage-technology/devhub-portal/actions/workflows/techdocs.yml/badge.svg)](https://github.com/vonage-technology/devhub-portal/actions/workflows/techdocs.yml)  

DevHub Developer Portal is a [Backstage](www.backstage.io) application. 

The project layout follows closely what is generated by the create-app CLI. See [Backstage documentation](https://backstage.io/docs/getting-started/).

## Development Environment

Backstage is a Node project, primarily written in TypeScript. Follow these steps to setup your development environment.

### Setup NVM (Node Version Manager)

The easiest way to install and manage Node is using [NVM](https://github.com/nvm-sh/nvm) (or [NVM for Windows](https://github.com/coreybutler/nvm-windows/releases)).

### Setup Node

Backstage suggests LTS versions of Nodejs, which are currently 14 and 16. Node 16 is recommended for now. Once nvm is installed proceed to install node:

```sh
nvm install 16
```

If you have multiple node versions install you can set 16 as your default:

```sh
nvm alias default 16
```


### Setup Typescript

```sh
npm install --global typescript
```

### Setup Yarn

Backstage is using yarn, so install that globally:

```sh
npm  install --global yarn
```

Run build to verify that everything works:

```sh
yarn build-all
```

### Setup Docker and Docker-Compose

Follow your OS instructions on installing [Docker and Docker-Compose](https://docs.docker.com/get-docker/)

### Configuration

Backstage reads configuration from `app-config.yaml` which can be overwritten from `app-config.local.yaml`.
See [here](https://backstage.io/docs/conf/) for more details. `app-config.local.yaml` is ignored by Git and
will typically contain secrets. Do not check it in.

Rename `app-config.local.yaml.sample` to `app-config.local.yaml` in order to specify some secrets for local run.

### Local Database

You will need a local PostgreSQL database to run/debug against.  The easiest was to handle this is using docker-compose. 

```yaml
version: "3"
services:
  postgres:
    image: "postgres"
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_DB: "backstage_plugin_catalog"
    volumes: 
      - /your/local/path:/var/lib/postgresql/data
```

Replace /your/local/path with a path on your local machine you want to keep the db files in and run:

```sh
docker-compose up -d
```

### Generate GitHub token

Backstage requires access to GitHub for various operations such as project catalog and scaffolding. In order to create a GitHub PAT (Personal Access Token):

1) Go to https://github.com/settings/tokens
1) Click on "Generate New Token"
1) Check the `repo` scope
1) Copy the token and put it in the `app-config.local.yaml` placeholders
1) Configure SSO for the Vonage org.

### Generate GitHub OAuth App
Backstage uses a GitHub OAuth app to authnticate users.  To set up an OAuth app:

1)  Go to https://github.com/settings/developers
2)  Click "New OAuth App"
3)  Enter a name (Recommend: `DevHub Local Development`)
4)  Enter Homepage Url: `http://localhost:3000`
5)  Enter Authorization callbackUrl: `http://localhost:7000/api/auth/github`
6)  Click "Update application"
7)  Copy Client Secret & ClientID and replace the placeholders in `app-config.local.yaml` 

## Running/Debugging
Assuming everythig is set up on you machine locally, simply run:

```sh
yarn dev
```

This should build & server both front & backend components of the application (Frontend runs on http://localhost:3000 & Backend on http://localhost:7000).

Then browse to http://localhost:3000

## Enabled Functionalities - Plugins

Backstage already comes with a number of plugins. For now, the ones that have been enabled are the following:

- [Software Catalog](https://backstage.io/docs/features/software-catalog/software-catalog-overview)
- [Software Templates](https://backstage.io/docs/features/software-templates/software-templates-index)
- [TechDocs](https://backstage.io/docs/features/techdocs/techdocs-overview)

## Submitting Changes / Sematic Versioning

We are using a trunk based development process.  To make changes:

1) Create a feature/bug branch.
2) Make and test your changes locally.
3) Push your changes to the remote (Github)
4) Create a pull request
   1) Be sure to enter notes for your pull-request about what you are changing
   2) Be sure to add a semantic version change type label to your pull-request. (valid labels are `major release`, `minor release`, `patch release`).  These labels drive the sematic versioning of the build artifacts in the CI process and are required.
      1) There are 2 gates on pull-requests, a successfull build, and a requred label.
5) Once your pull request is approved and merged to main it will automatically kick of the semantic versioning process and a CI build which will publish 2 docker images to our registry (one for the frontend app and one for the backend app).
6) Use DevHub to deploy the resulting release.
